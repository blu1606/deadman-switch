# 6.5 Silent Alarm (Duress Mode)

> "When someone forces you to check in at gunpoint."

## ğŸ¯ Goal
Provide a panic button that LOOKS like a normal check-in but secretly alerts emergency contacts.

## ğŸ“ How It Works

```
Normal Check-in:
[Hold Button 2s] â†’ Transaction sent â†’ Timer resets

Duress Check-in (one of):
Option A: [Hold Button 5s instead of 2s]
Option B: [Enter secret "duress password" before check-in]
Option C: [Triple-tap before holding]
```

## ğŸ“ What Happens in Duress Mode

1. **Fake UI:** Shows "âœ… Check-in successful!" 
2. **No Transaction:** Timer NOT actually reset (or send dummy tx)
3. **SOS Alert:** API sends emergency email to pre-configured contacts
4. **Optional:** Include approximate location (browser geolocation API)

## ğŸ› ï¸ Implementation

### Frontend (HoldCheckInButton.tsx)
```typescript
const [holdStart, setHoldStart] = useState<number | null>(null);

const handleHoldComplete = async (duration: number) => {
  if (duration >= 5000) {
    // DURESS MODE
    await fetch('/api/alert/duress', {
      method: 'POST',
      body: JSON.stringify({
        vaultId: vault.publicKey,
        location: await getLocation(),
      }),
    });
    
    // Fake success UI
    toast.success("Check-in successful!");
    setFakeCheckedIn(true);
    
    // DO NOT call actual ping transaction
    return;
  }
  
  // Normal check-in
  await ping();
};
```

### API (/api/alert/duress)
```typescript
export async function POST(req: Request) {
  const { vaultId, location } = await req.json();
  
  // Get vault owner's emergency contacts from database
  const contacts = await getEmergencyContacts(vaultId);
  
  await resend.emails.send({
    to: contacts,
    subject: 'ğŸš¨ URGENT: Duress Alert',
    html: `
      <h1>Emergency Alert</h1>
      <p>A duress check-in was detected.</p>
      <p>Location: ${location || 'Unknown'}</p>
      <p>Time: ${new Date().toISOString()}</p>
      <p>This may indicate the vault owner is in danger.</p>
    `,
  });
  
  return Response.json({ sent: true });
}
```

### Settings UI
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš¨ Silent Alarm Setup                                   â”‚
â”‚                                                         â”‚
â”‚ Enable duress mode for emergencies                      â”‚
â”‚ [Toggle: ON]                                            â”‚
â”‚                                                         â”‚
â”‚ Trigger method:                                         â”‚
â”‚ â—‹ Hold check-in button for 5 seconds                    â”‚
â”‚ â—‹ Triple-tap before check-in                            â”‚
â”‚                                                         â”‚
â”‚ Emergency contacts:                                     â”‚
â”‚ â€¢ alice@example.com                          [Remove]   â”‚
â”‚ â€¢ +84 123 456 789 (SMS)                      [Remove]   â”‚
â”‚ [+ Add contact]                                         â”‚
â”‚                                                         â”‚
â”‚ âš ï¸ These contacts will be notified if you trigger       â”‚
â”‚    a silent alarm.                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš ï¸ Considerations

1. **Káº» xáº¥u check transaction:** 
   - Solution: Send dummy 0.00001 SOL tx to self
   - Or: Accept risk, most attackers won't check blockchain

2. **Accidental trigger:**
   - Make threshold clear (5s is long)
   - Add confirmation for settings

3. **Database needed:**
   - Store emergency contacts
   - Could use Supabase (already have for emails?)

## ğŸ’° Cost
- Frontend logic: Free
- Email via Resend: ~$0
- No contract changes

## âœ… Execution Steps

- [x] Add duress detection to HoldCheckInButton
- [x] Create /api/alert/duress endpoint
- [x] Add emergency contacts to settings (via EditVaultModal)
- [x] Store contacts in database (Supabase `emergency_contacts`)
- [ ] Test flow end-to-end

---

## âœ… Implementation Status: COMPLETE

### Frontend Files
- `HoldCheckInButton.tsx`: Duress detection (5s hold)
- `VaultCard.tsx`: `onDuress` prop passed to button
- `DashboardPage.tsx`: `handleDuress` calls API with location
- `DuressSettings.tsx`: UI component for settings
- `EditVaultModal.tsx`: Integrates DuressSettings
- `useEditVault.ts`: Saves to Supabase via API

### API Endpoints
- `/api/alert/duress`: Sends email to emergency contacts
- `/api/vault/contact`: Saves emergency contacts to Supabase

### User Flow
1. User goes to Dashboard â†’ Edit Vault Settings
2. Enables "Duress Mode" and enters emergency email
3. Saves â†’ Contact stored in Supabase
4. Under duress: Hold check-in for 5 seconds
5. Silent alarm triggers â†’ Emergency email sent
6. UI shows fake "Check-in successful" to attacker
