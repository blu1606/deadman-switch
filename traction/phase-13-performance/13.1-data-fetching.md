# 13.1 Data Fetching Architecture (TanStack Query)

> **Goal:** Eliminate "loading waterfall" and expensive RPC calls  
> **Tool:** `@tanstack/react-query`  
> **Impact:** Instant navigation, background updates, reduced RPC cost

---

## ðŸŽ¯ Problem Analysis

**Current State:**
- `useVault` uses `useEffect` + `connection.getProgramAccounts`.
- **Waterfall:** Component Mount -> Effect -> Fetch.
- **Redundant:** Navigating Home -> Dashboard -> Home triggers 3 fetches.
- **UX:** "Loading..." spinners everywhere.

**Target State:**
- **Cache-First:** Data loads instantly from memory if visited recently.
- **Background Refetch:** Data updates silently.
- **Deduping:** Multiple components asking for vault data trigger 1 network call.

---

## ðŸ› ï¸ Implementation Plan

### 1. Installation
```bash
npm install @tanstack/react-query @tanstack/react-query-devtools
```

### 2. Provider Setup (Layout)
Wrap `app/layout.tsx` (or `Providers.tsx`):
```tsx
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60, // Data fresh for 1 min
      gcTime: 1000 * 60 * 5, // Keep in memory 5 mins
      refetchOnWindowFocus: false, // Optional: reduce RPC spam
    },
  },
})
```

### 3. Refactor `useVault.ts`

**Key Pattern:**
- Use `publicKey` as part of Query Key.
- Return `parseVaultAccount` result directly.

```tsx
import { useQuery } from '@tanstack/react-query';

export function useOwnerVaults() {
  const { publicKey, connection } = useWalletAndConnection();

  return useQuery({
    queryKey: ['vaults', publicKey?.toBase58()],
    queryFn: async () => {
      if (!publicKey) return [];
      // ... fetch logic ...
      return parsedVaults;
    },
    enabled: !!publicKey, // Only run if wallet connected
    staleTime: 30 * 1000, // 30s fresh
  });
}
```

### 4. Optimistic Updates (Mutations)
For `ping()` or `create()`:
```tsx
const mutation = useMutation({
  mutationFn: (vault) => program.methods.ping()...rpc(),
  onSuccess: () => {
    // Invalidate to refetch fresh data
    queryClient.invalidateQueries({ queryKey: ['vaults'] });
  },
});
```

---

## âš¡ Performance Wins

| Metric | Before | After |
|--------|--------|-------|
| **Nav Latency** | ~800ms (Loading) | **0ms (Cache)** |
| **RPC Calls** | 1 per mount | **1 per staleTime** |
| **UI Stability** | Jumpy spinners | **Stable** |

---

## âœ… Checklist

- [ ] Install dependencies
- [ ] Add `QueryClientProvider`
- [ ] Refactor `useOwnerVaults` to `useQuery`
- [ ] Refactor `useVault` (wrapper)
- [ ] Test navigation (no spinner on back button)
